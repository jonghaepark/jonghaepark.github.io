<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- Basic meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Periodic Skill Discovery">
  <meta name="keywords" content="Reinforcement Learning, Unsupervised Skill Discovery, Periodicity">

  <title>Periodic Skill Discovery</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <link rel="icon" href="./static/images/favicon.svg">

  <!-- JS -->
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>

</head>
<body>

<!-- NAVBAR -->
<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div class="navbar-menu">
    <div class="navbar-start" style="flex-grow:1; justify-content:center;">
      <a class="navbar-item" href="https://jonghaepark.github.io/" aria-label="Top">
        <span class="icon"><i class="fas fa-home"></i></span>
      </a>
      <a class="navbar-item" href="#abstract">Abstract</a>
      <a class="navbar-item" href="#results">Results</a>
      <a class="navbar-item" href="#bibtex">BibTeX</a>
    </div>
  </div>
</nav>

<!-- HERO / TITLE -->
<section class="hero" id="top">
  <div class="hero-body">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column has-text-centered">
          <h1 class="title is-1 publication-title">Periodic Skill Discovery</h1>

      <div class="is-size-5 publication-authors">
        <span class="author-block" style="margin-right: 0.6em;"><a href="https://jonghaepark.github.io/" rel="noopener">Jonghae Park<sup>1</sup></a></span>
        <span class="author-block" style="margin-right: 0.6em;">Daesol Cho<sup>2</sup></span>
        <span class="author-block" style="margin-right: 0.6em;">Jusuk Lee<sup>1</sup></span>
        <span class="author-block" style="margin-right: 0.6em;">Dongseok Shim<sup>1</sup></span>
        <span class="author-block" style="margin-right: 0.6em;">Inkyu Jang<sup>1</sup></span>
        <span class="author-block">H. Jin Kim<sup>1</sup></span>
      </div>

      <div class="is-size-6 publication-authors" style="margin-top: 4px;">
        <span class="author-block" style="margin-right: 0.6em;"><sup>1</sup>Seoul National University</span>
        <span class="author-block"><sup>2</sup>Georgia Institute of Technology</span>
      </div>

      <div class="is-size-6 has-text-weight-semibold" style="color: #FA5543; margin-top: 6px;">
        Accepted at NeurIPS 2025
      </div>
          <p class="has-text-danger" style="margin-top: 4px;">
            Iâ€™m currently working on this project page â€” please check back soon!
          </p>
          <div class="column has-text-centered">
            <div class="publication-links">
              <!-- Update hrefs to your files/links -->
              <span class="link-block">
                <a href="./static/videos/psd_paper.pdf" class="button is-normal is-rounded is-dark">
                  <span class="icon"><i class="fas fa-file-pdf"></i></span><span>Paper (PDF)</span>
                </a>
              </span>
              <span class="link-block">
                <a href="https://arxiv.org/abs/XXXX.XXXXX" class="button is-normal is-rounded is-dark">
                  <span class="icon"><i class="ai ai-arxiv"></i></span><span>arXiv</span>
                </a>
              </span>
              <span class="link-block">
                <a href="https://github.com/yourrepo/psd" class="button is-normal is-rounded is-dark">
                  <span class="icon"><i class="fab fa-github"></i></span><span>Code</span>
                </a>
              </span>
              <span class="link-block">
                <a href="./static/videos/psd_poster.pdf" class="button is-normal is-rounded is-dark">
                  <span class="icon"><i class="far fa-image"></i></span><span>Poster</span>
                </a>
              </span>
            </div>
          </div>

        </div> <!-- column -->
      </div> <!-- columns -->
    </div> <!-- container -->
  </div> <!-- hero-body -->
</section>

<!-- TEASER -->
<section class="section" id="teaser-section" style="padding-top: 3rem; padding-bottom: 2rem;">
  <div class="container" style="text-align: center; max-width: 1100px;">

    <!-- PDFâ†’SVG ì´ë¯¸ì§€ -->
    <img src="./static/images/psd_teaser.svg"
         alt="Periodic Skill Discovery Teaser"
         style="
           max-width: 90%;
           height: auto;
           margin-bottom: 1.2rem;
           border-radius: 10px;
         ">


    <h2 class="subtitle"
        style="
          all: unset;                  /* ðŸ‘ˆ ê¸°ë³¸ h2/subtitle ìŠ¤íƒ€ì¼ ì™„ì „ ì´ˆê¸°í™” */
          display: block;
          font-style: italic;
          font-size: 1.4rem;
          color: #333;
          line-height: 1.3;
          letter-spacing: 0.015em;
          text-align: center;
          margin: 0;                   /* ðŸ‘ˆ ìœ„ì•„ëž˜ ì—¬ë°± ì™„ì „ ì œê±° */
          padding: 0;                  /* ðŸ‘ˆ ë‚´ë¶€ ì—¬ë°±ë„ ì œê±° */
        ">
      Fundamental observation in nature is that nearly all forms of locomotion are inherently periodic!
    </h2>
  </div>
</section>


<!-- ABSTRACT -->
<section class="section" id="abstract">
  <div class="container is-max-desktop">
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Abstract</h2>
        <div class="content has-text-justified">
          <p>
            Unsupervised skill discovery in reinforcement learning (RL) aims to learn diverse behaviors without relying on external rewards. However, current methods often overlook the periodic nature of learned skills, focusing instead on increasing the mutual dependency between states and skills or maximizing the distance traveled in latent space. Considering that many robotic tasksâ€”particularly those involving locomotionâ€”require periodic behaviors across varying timescales, the ability to discover diverse periodic skills is essential. Motivated by this, we propose <b>Periodic Skill Discovery (PSD)</b>, a framework that discovers periodic behaviors in an unsupervised manner. The key idea of PSD is to train an encoder that maps states to a circular latent space, thereby naturally encoding periodicity in the latent representation. By capturing temporal distance, PSD can effectively learn skills with diverse periods in complex robotic tasks, even with pixel-based observations. We further show that these learned skills achieve high performance on downstream tasks such as hurdling. Moreover, integrating PSD with an existing skill discovery method offers more diverse behaviors, thus broadening the agentâ€™s repertoire.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- REL WORK -->
<section class="section" id="method">
  <div class="container" style="max-width: 1100px; margin: 0 auto;">
    <div class="columns is-centered">
      <div class="column is-full-width">
        <h2 class="title is-3" style="text-align: left;">
          Why might previous methods fail to learn multi-timescale behaviors?
        </h2>

        <div class="content" style="text-align: left;">

          <p>
            Existing unsupervised skill discovery methods typically maximize either the
            <i>mutual information</i> between states and skills or the <i>distance</i>
            between latent representations. However, both approaches struggle to explicitly
            regulate <b>multi-timescale periodic behaviors</b>.
          </p>

          <!-- 1) MI-based -->
          <h4 class="title is-4" style="margin-top: 1.5em; text-align: left;">
            1. Mutual Information-based Skill Discovery
          </h4>
          <p>
            MI-based approaches maximize the dependency between states \(S\) and skills \(Z\),
            so that each skill corresponds to distinguishable states:
          </p>

          <p style="margin: 0.8em 0;">
            \[
              I(S;Z)
              = \mathbb{E}_{z,\tau}[\log p(z\!\mid\!s)]
              - \mathbb{E}_{z}[\log p(z)]
              \;\;\approx\;\;
              \mathbb{E}_{z,\tau}[\log q_\theta(z\!\mid\!s)] + \text{const}.
            \]
          </p>

          <p>
            Here, \(q_\theta(z\!\mid\!s)\) is a skill discriminator that infers the skill
            from the current state. The agent is rewarded when the discriminator can predict
            the skill with high confidence. Consequently, these methods tend to produce
            <b>easy-to-distinguish but static</b> skills, offering little incentive for
            temporally rich or periodic behaviors.
          </p>

          <!-- 2) Distance-maximizing -->
          <h4 class="title is-4" style="margin-top: 1.5em; text-align: left;">
            2. Distance-Maximizing Skill Discovery
          </h4>
          <p>
            Distance-based methods instead learn latent embeddings that maximize the
            displacement between consecutive states along skill directions:
          </p>

          <p style="margin: 0.8em 0;">
            \[
              \mathcal{J}_{\text{DSD}}
              := \mathbb{E}_{(z,\tau)\sim\mathcal{D}}
              \big[(\phi(s_{t+1})-\phi(s_t))^\top z\big]
              \quad \text{s.t.}\quad
              \|\phi(x)-\phi(y)\| \le d(x,y),\;\forall x,y\in\mathcal{D}.
            \]
          </p>

          <p>
            Depending on the metric \(d\) (e.g., Euclidean, controllability-aware,
            temporal, or language-based), the agent discovers behaviors that move far in
            the latent space. However, this objective encourages only
            <b>maximally deviating or fast-moving behaviors</b>, without providing an
            incentive to modulate their <b>temporal scale or periodicity</b>.
          </p>

          <!-- Clean takeaway with translucent gray box -->
          <div style="
            margin-top: 2em;
            padding: 1em 1.2em;
            background: rgba(240, 240, 240, 0.8);
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            color: #444;
          ">
            In short, MI-based methods favor discriminability, and distance-based methods
            favor magnitude of deviation â€” neither captures the <b>temporal structure</b>
            essential for <b>multi-timescale periodic behaviors</b>.
          </div>

        </div>
      </div>
    </div>
  </div>
</section>



<!-- METHOD -->
<section class="section" id="Periodic Skill Discovery">
  <div class="container" style="max-width: 1100px; margin: 0 auto;">
    <div class="columns is-centered">
      <div class="column is-full-width">
        <h2 class="title is-3" style="text-align: left;">Periodic Skill Discovery</h2>

        <div class="content" style="text-align: left;">
          <p>
            <b>Periodic Skill Discovery (PSD)</b> is a framework for unsupervised skill discovery 
            that captures the <b>periodic nature</b> of behaviors by embedding states into a 
            <b>circular latent space</b>. By optimizing a constrained objective that encodes 
            temporal distance, PSD enables agents to learn periodic behaviors with 
            <b>controllable periods</b> across multiple timescales.
          </p>

          <!-- 1. Circular Latent Representation -->
          <h4 class="title is-4" style="margin-top: 1.5em;">1. Circular Latent Representation</h4>
          <p>
            PSD trains an encoder \( \phi_L(s) \) that maps each state \( s \) to a point 
            on a circle of diameter \( L \), where \( L \) denotes the skillâ€™s period variable.
            The objective encourages states \( s_t \) and \( s_{t+L} \) to lie at opposite 
            points on the circle while maintaining uniform angular spacing between 
            consecutive states:
          </p>

          <p style="margin: 0.8em 0;">
            \[
              \mathcal{J}_{\text{PSD}}
              = \mathbb{E}\!\left[
                \|\phi_L(s_{t+L}) - \phi_L(s_t)\|^2
                - k \|\phi_L(s_{t+L}) + \phi_L(s_t)\|^2
              \right]
            \]
            \[
              \text{s.t. } 
              \|\phi_L(s_{t+L}) - \phi_L(s_t)\| \le L,\quad
              \|\phi_L(s_{t+1}) - \phi_L(s_t)\| \le L \sin\!\left(\tfrac{\pi}{2L}\right).
            \]
          </p>

          <p>
            These constraints ensure that the latent representation forms a regular 
            \( 2L \)-gon on the circle, making each skillâ€™s trajectory periodic with a 
            full rotation every \( 2L \) steps.
          </p>

          <!-- 2. Single-Step Intrinsic Reward -->
          <h4 class="title is-4" style="margin-top: 1.5em;">2. Single-step Intrinsic Reward</h4>
          <p>
            The agent is jointly trained with a single-step intrinsic reward that encourages
            consistent motion along the circular latent path. The deviation from the 
            ideal step length \( L \sin(\pi/2L) \) defines the reward:
          </p>

          <p style="margin: 0.8em 0;">
            \[
              r_{\text{PSD}}(s_t, s_{t+1}, L)
              = \exp\!\Big(-\kappa \big(
                \|\phi_L(s_{t+1}) - \phi_L(s_t)\|
                - L \sin\!\tfrac{\pi}{2L}
              \big)^2\Big),
            \]
          </p>

          <p>
            Maximizing \( r_{\text{PSD}} \) makes the policy follow a smooth circular 
            trajectory in latent space, yielding behaviors that naturally repeat every 
            \( 2L \) steps.
          </p>

          <!-- 3. Adaptive Sampling -->
          <h4 class="title is-4" style="margin-top: 1.5em;">3. Adaptive Sampling Method</h4>
          <p>
            To autonomously explore diverse periods, PSD adaptively adjusts the sampling 
            range \( [L_{\min}, L_{\max}] \) based on the agentâ€™s performance. When the 
            policy successfully maintains periodicity for the current bounds, the range is 
            expanded, allowing discovery of longer or shorter cycles over training.
          </p>

          <!-- takeaway -->
          <div style="
            margin-top: 2em;
            padding: 1em 1.2em;
            background: rgba(240,240,240,0.8);
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            color: #444;
          ">
            By mapping states to a circular latent space and optimizing for temporal 
            distance, PSD learns <b>multi-timescale periodic skills</b> that are 
            geometrically interpretable and effective even from pixel-based inputs.
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<!-- METHOD -->
<section class="section" id="Periodic Skill Discovery">
  <div class="container" style="max-width: 1100px; margin: 0 auto;">
    <div class="columns is-centered">
      <div class="column is-full-width">
        <h2 class="title is-3" style="text-align: left;">Can PSD discover diverse periodic skills across multiple timescales?</h2>
        <div class="content" style="text-align: left;">
        Add figure 3
        Add Adaptive sampling 
        </div>
      </div>
    </div>
  </div>
</section>

<!-- RESULTS / CAROUSEL + INTERPOLATION -->
<section class="section" id="results">
  <div class="container" style="max-width: 1100px; margin: 0 auto;">

    <!-- RESULTS -->
    <div class="columns is-centered">
      <div class="column is-full-width has-text-centered">
        <h2 class="title is-3" style="text-align: left;">Results</h2>

        <!-- 1. STATE-BASED -->
        <h4 class="title is-4" style="margin-top: 1.5em; text-align: left;">1. State-based Environment</h4>
        <div class="has-text-centered" style="margin-top:1rem;">
          <video id="video-state" muted playsinline loop preload="metadata"
                style="max-width:100%; height:auto;"></video>
          
        </div>
        <div class="video-switcher" id="switcher-state" role="group" aria-label="State environment selector"
            style="margin-top: 1rem;">
          <button class="btn-pill is-active" data-src="./static/videos/psd_teaser.mp4">Ant</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">HalfCheetah</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">Humanoid</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">Hopper</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">Walker2D</button>
        </div>

        <!-- 2. PIXEL-BASED -->
        <h4 class="title is-4" style="margin-top: 1.5em; text-align: left;">2. Pixel-based Environment</h4>
        <div class="has-text-centered" style="margin-top:1rem;">
          <video id="video-pixel" muted playsinline loop preload="metadata"
                style="max-width:100%; height:auto;"></video>
        </div>
        <div class="video-switcher" id="switcher-pixel" role="group" aria-label="Pixel environment selector"
            style="margin-top: 1rem;">
          <button class="btn-pill is-active" data-src="./static/videos/psd_teaser.mp4">Ant</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">HalfCheetah</button>
        </div>

        <!-- 3. METRA COMBINATION -->
        <h4 class="title is-4" style="margin-top: 1.5em; text-align: left;">3. Combination with METRA</h4>
        <div class="has-text-centered" style="margin-top:1rem;">
          <video id="video-metra" muted playsinline loop preload="metadata"
                style="max-width:100%; height:auto;"></video>
        </div>
        <div class="video-switcher" id="switcher-metra" role="group" aria-label="METRA environment selector"
            style="margin-top: 1rem;">
          <button class="btn-pill is-active" data-src="./static/videos/psd_teaser.mp4">Ant</button>
          <button class="btn-pill" data-src="./static/videos/psd_teaser.mp4">Walker2D</button>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- BIBTEX -->
<section class="section" id="bibtex">
  <div class="container" style="max-width: 1100px; margin: 0 auto;">
    <h2 class="title">BibTeX</h2>
    <pre><code>@inproceedings{park2025psd,
  author    = {Park, Jonghae and Cho, Daesol and Lee, Jusuk and Shim, Dongseok and Jang, Inkyu and Kim, H. Jin},
  title     = {Periodic Skill Discovery},
  booktitle = {NeurIPS},
  year      = {2025}
}</code></pre>
  </div>
</section>

<!-- FOOTER (license note kept minimal) -->
<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <a class="icon-link"
         href="./static/videos/nerfies_paper.pdf">
        <i class="fas fa-file-pdf"></i>
      </a>
      <a class="icon-link" href="https://github.com/keunhong" class="external-link" disabled>
        <i class="fab fa-github"></i>
      </a>
    </div>
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content">
          <p>
            This website is licensed under a <a rel="license"
                                                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
            Commons Attribution-ShareAlike 4.0 International License</a>.
          </p>
          <p>
            This means you are free to borrow the <a
              href="https://github.com/nerfies/nerfies.github.io">source code</a> of this website,
            we just ask that you link back to this page in the footer.
            Please remember to remove the analytics code included in the header of the website which
            you do not want on your website.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // â‘  ì—¬ëŸ¬ ìŒ ìžë™ ì²˜ë¦¬: idê°€ 'video-*' í˜•íƒœì¸ ëª¨ë“  ë¹„ë””ì˜¤ íƒìƒ‰
  const multiVideos = Array.from(document.querySelectorAll('video[id^="video-"]'));
  const groups = [];

  multiVideos.forEach(vid => {
    const suffix = vid.id.replace(/^video-/, '');              // ex) 'state'
    const switcher = document.getElementById(`switcher-${suffix}`);
    if (switcher) groups.push({ videoEl: vid, switcherEl: switcher });
  });

  // â‘¡ ë ˆê±°ì‹œ(ë‹¨ì¼ ìŒ) ì§€ì›: ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œë„ ë™ìž‘í•˜ë„ë¡ ë°±ì—… ê²½ë¡œ
  const legacyVideo = document.getElementById('result-video');
  const legacySwitcher = document.querySelector('#video-switcher');
  if (!groups.length && legacyVideo && legacySwitcher) {
    groups.push({ videoEl: legacyVideo, switcherEl: legacySwitcher });
  }

  // ê·¸ë£¹ ì´ˆê¸°í™” í•¨ìˆ˜
  function initGroup(video, switcher, allVideos) {
    const buttons = Array.from(switcher.querySelectorAll('.btn-pill'));
    if (!buttons.length) return;

    // í˜„ìž¬ ê·¸ë£¹ ì™¸ ë‚˜ë¨¸ì§€ ëª¨ë‘ ì •ì§€í•˜ëŠ” í—¬í¼
    function pauseOthers() {
      allVideos.forEach(v => { if (v !== video) v.pause(); });
    }

    function setActive(btn) {
      buttons.forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('is-active'); btn.setAttribute('aria-pressed','true');
    }

    // ì „í™˜ ë¡œì§
    async function switchVideo(src) {
      if (!src) return;
      pauseOthers();

      const abs = new URL(src, location.href).href;
      // ê°™ì€ ì†ŒìŠ¤ë©´ ìž¬ë²„í¼ ê¸ˆì§€: ì²˜ìŒë¶€í„°ë§Œ ìž¬ìƒ
      if (video.currentSrc === abs || video.src === abs) {
        try { video.pause(); video.currentTime = 0.001; } catch(e){}
        const p = video.play(); if (p && p.catch) p.catch(()=>{});
        return;
      }

      // ì•ˆì „ êµì²´
      video.pause();
      video.removeAttribute('src');
      while (video.firstChild) video.removeChild(video.firstChild);
      const srcMp4 = document.createElement('source');
      srcMp4.src = src;
      srcMp4.type = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
      video.appendChild(srcMp4);
      try { video.load(); } catch(e){}

      let fired = false;
      const resume = () => {
        if (fired) return; fired = true;
        try { if (video.currentTime === 0) video.currentTime = 0.001; } catch(e){}
        const p = video.play(); if (p && p.catch) p.catch(()=>{});
      };
      const onCPT = () => { video.removeEventListener('canplaythrough', onCPT); resume(); };
      const onLD  = () => { video.removeEventListener('loadeddata', onLD); resume(); };

      video.addEventListener('canplaythrough', onCPT, { once:true });
      video.addEventListener('loadeddata', onLD, { once:true });
    }

    const initial = buttons.find(b=>b.classList.contains('is-active')) || buttons[0];
    if (initial) { setActive(initial); switchVideo(initial.dataset.src); }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => { setActive(btn); switchVideo(btn.dataset.src); });
    });
  }

  // ê¸°ì¡´ ê·¸ë£¹ ì´ˆê¸°í™” ì‹œ allVideos ë„˜ê²¨ì¤˜ì„œ êµì°¨ ì •ì§€
  const multiVideos = Array.from(document.querySelectorAll('video[id^="video-"]'));
  const groups = multiVideos.map(vid => {
    const suffix = vid.id.replace(/^video-/, '');
    const switcher = document.getElementById(`switcher-${suffix}`);
    return switcher ? { videoEl: vid, switcherEl: switcher } : null;
  }).filter(Boolean);
  groups.forEach(({ videoEl, switcherEl }) => initGroup(videoEl, switcherEl, multiVideos));

</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === ëª¨ë“  ê²°ê³¼ ë¹„ë””ì˜¤ ìˆ˜ì§‘ ===
  const allVideos = Array.from(document.querySelectorAll('video[id^="video-"]'));
  const visibleMap = new WeakMap(); // ê° ë¹„ë””ì˜¤ì˜ ê°€ì‹œ ìƒíƒœ ì €ìž¥

  // ê¸°ë³¸ ì„¸íŒ…
  allVideos.forEach(v => {
    v.preload = 'metadata';
    v.setAttribute('muted', '');
    v.setAttribute('playsinline', '');
  });

  // === ê°€ì‹œì„± ê¸°ë°˜ ìž¬ìƒ ì œì–´ ===
  function playIfVisible(v) {
    if (visibleMap.get(v)) {
      const p = v.play();
      if (p && p.catch) p.catch(()=>{});
    } else {
      v.pause();
    }
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      const visible = e.isIntersecting && e.intersectionRatio > 0.6;
      visibleMap.set(e.target, visible);
      playIfVisible(e.target);
    });
  }, { threshold: [0, 0.6, 1] });

  allVideos.forEach(v => io.observe(v));

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      allVideos.forEach(v => v.pause());
    } else {
      allVideos.forEach(v => playIfVisible(v));
    }
  });

  // === ê·¸ë£¹(ë²„íŠ¼ â†” ë¹„ë””ì˜¤) ë§¤ì¹­ ===
  const groups = [];
  allVideos.forEach(vid => {
    const suffix = vid.id.replace(/^video-/, '');   // ex) 'state'
    const switcher = document.getElementById(`switcher-${suffix}`);
    if (switcher) groups.push({ videoEl: vid, switcherEl: switcher });
  });

  // ë ˆê±°ì‹œ(ë‹¨ì¼ ìŒ) ë°±ì—…
  const legacyVideo = document.getElementById('result-video');
  const legacySwitcher = document.querySelector('#video-switcher');
  if (!groups.length && legacyVideo && legacySwitcher) {
    groups.push({ videoEl: legacyVideo, switcherEl: legacySwitcher });
  }

  // ë‹¤ë¥¸ ë¹„ë””ì˜¤ëŠ” ì¦‰ì‹œ ì •ì§€
  function pauseOthers(target) {
    allVideos.forEach(v => { if (v !== target) v.pause(); });
  }

  // ì•ˆì „í•œ ì†ŒìŠ¤ ì „í™˜
  function switchVideo(video, src) {
    if (!src) return;

    pauseOthers(video);

    const abs = new URL(src, window.location.href).href;
    const same = (video.currentSrc === abs || video.src === abs);

    if (same) {
      try { video.pause(); video.currentTime = 0.001; } catch(e){}
      playIfVisible(video);   // ê°€ì‹œ ìƒíƒœì—ì„œë§Œ ìž¬ìƒ
      return;
    }

    video.pause();
    video.removeAttribute('src');
    while (video.firstChild) video.removeChild(video.firstChild);

    const s = document.createElement('source');
    s.src  = src;
    s.type = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
    video.appendChild(s);

    try { video.load(); } catch(e){}

    let fired = false;
    const resume = () => {
      if (fired) return; fired = true;
      try { if (video.currentTime === 0) video.currentTime = 0.001; } catch(e){}
      playIfVisible(video);
    };
    const onCPT = () => { video.removeEventListener('canplaythrough', onCPT); resume(); };
    const onLD  = ()  => { video.removeEventListener('loadeddata', onLD);     resume(); };

    video.addEventListener('canplaythrough', onCPT, { once:true });
    video.addEventListener('loadeddata', onLD, { once:true });
  }

  // ê·¸ë£¹ ì´ˆê¸°í™”
  function initGroup(video, switcher) {
    const buttons = Array.from(switcher.querySelectorAll('.btn-pill'));
    if (!buttons.length) return;

    function setActive(btn) {
      buttons.forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('is-active'); btn.setAttribute('aria-pressed','true');
    }

    const initial = buttons.find(b => b.classList.contains('is-active')) || buttons[0];
    if (initial) {
      setActive(initial);
      switchVideo(video, initial.getAttribute('data-src'));
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        setActive(btn);
        switchVideo(video, btn.getAttribute('data-src'));
      });
    });
  }

  groups.forEach(({ videoEl, switcherEl }) => initGroup(videoEl, switcherEl));
});
</script>

<!-- MathJax for equations (keep once per page) -->
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


</body>
</html>
